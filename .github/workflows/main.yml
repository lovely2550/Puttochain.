name: Putthochain Backend CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

# กำหนดตัวแปรสภาพแวดล้อมที่ใช้ร่วมกัน
env:
  DOCKER_IMAGE_NAME: puttochain-backend
  REGISTRY: ghcr.io # GitHub Container Registry
  PYTHON_VERSION: '3.10'

jobs:
  # 1. Build และ Test Logic (CI)
  build-and-test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install dependencies
      run: |
        pip install -e .[test] # ติดตั้ง packages ทั้งหมดรวมถึง pytest
        pip install uvicorn[standard] # จำเป็นสำหรับการทดสอบ

    - name: Lint with Flake8
      run: |
        # ตรวจสอบรูปแบบโค้ด
        pip install flake8
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 . --count --max-complexity=10 --max-line-length=120 --statistics

    - name: Run Pytest and calculate Coverage
      run: |
        # รันชุดทดสอบทั้งหมด
        pytest --cov=puttochain --cov-report=xml

    - name: Upload coverage report to Codecov
      uses: codecov/codecov-action@v4 
      # ช่วยแสดงผลลัพธ์ความครอบคลุมของการทดสอบใน GitHub UI

  # 2. Build Docker Image และ Push ไปยัง Registry
  build-and-push-docker:
    needs: build-and-test # ต้องผ่านการทดสอบก่อนถึงจะ Build
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Extract metadata (tags, labels) for Docker
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ github.repository }}/${{ env.DOCKER_IMAGE_NAME }}

    - name: Build and Push Docker image
      uses: docker/build-and-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}

  # 3. Deployment ไปยัง Cloud Hosting (CD)
  deploy:
    needs: build-and-push-docker # ต้อง Build และ Push image สำเร็จก่อน
    runs-on: ubuntu-latest
    environment: Production
    steps:
    - name: Deploy to Render/Custom Host
      uses: appleboy/ssh-action@v1.0.1
      with:
        host: ${{ secrets.DEPLOYMENT_HOST }} # IP หรือ Domain ของ Server
        username: ${{ secrets.DEPLOYMENT_USER }}
        key: ${{ secrets.DEPLOYMENT_KEY }}
        script: |
          echo "Deployment started on host..."
          
          # ดึง Docker Image ล่าสุดที่เพิ่ง Push
          docker pull ${{ steps.meta.outputs.tags }}
          
          # หยุด Container เก่า และลบมัน
          docker stop ${{ env.DOCKER_IMAGE_NAME }} || true
          docker rm ${{ env.DOCKER_IMAGE_NAME }} || true
          
          # รัน Container ใหม่ พร้อม Load Environment Variables ที่สำคัญ
          docker run -d \
            --name ${{ env.DOCKER_IMAGE_NAME }} \
            -p 80:8000 \
            -e DATABASE_URL=${{ secrets.DATABASE_URL }} \
            -e ADMIN_PRIVATE_KEY=${{ secrets.ADMIN_PRIVATE_KEY }} \
            -e POLYGON_RPC_URL=${{ secrets.POLYGON_RPC_URL }} \
            ${{ steps.meta.outputs.tags }}
            
          echo "Putthochain API deployed successfully!"
